version: 2.1

orbs:
    win: circleci/windows@5.0.0

jobs:
    build:
        executor: win/server-2022
        steps:
            - add_ssh_keys:
                fingerprints:
                  - "SHA256:Vez+9ng8BrMKVo1RJUa68647BVC9Rihu1rZVRiShbT4"
            - checkout
            - run: 
                name: Checkout Submodules
                command: |
                    git submodule sync
                    git submodule update --init --recursive
            - run:
                name: Download 7Zip
                command: |
                    & "C:\windows\system32\curl.exe" -L -o "${HOME}/7z.exe" "https://www.7-zip.org/a/7zr.exe"
            - restore_cache:
                name: Restoring VCPKG Cache
                key: vcpkg-{{ checksum "vcpkg.json" }}
            - restore_cache:
                name: Restore DX9 SDK Cache
                key: dx9-sdk
            - run: 
                name: Install VCPKG
                command: .ci\install-vcpkg.ps1
            - run: 
                name: Install Dependencies
                command: .ci\install-dependencies.ps1
                no_output_timeout: 25m
            - save_cache:
                name: Caching VCPKG Packages
                key: vcpkg-{{ checksum "vcpkg.json" }}
                paths:
                    - vcpkg_installed
            - save_cache:
                name: Caching DX9 SDK
                key: dx9-sdk
                paths:
                    - C:\Users\circleci\DirectXSDK
            - run: 
                name: Build Project
                command: .ci\build-project.ps1
            - run:
                name: "Compress Release"
                command: 
                    mkdir C:\Users\circleci\artifacts
                    7z a -r C:\Users\circleci\artifacts\ChaosMod.7z ./ChaosMod/Release/*
            - persist_to_workspace:
                root: C:\Users\circleci\artifacts
                paths: 
                    - ChaosMod.7z

    release:
        docker:
            - image: cibuilds/github:0.10
        steps:
            - attach_workspace:
                at: C:\Users\circleci\artifacts
            - run:
                name: Publish Release on GitHub
                command: |
                    VERSION=$(date +"%Y-%m-%d")
                    ghr -t ${GITHUB_TOKEN} -u ${CIRCLE_PROJECT_USERNAME} -r ${CIRCLE_PROJECT_REPONAME} -c ${CIRCLE_SHA1} -delete ${VERSION} C:\Users\circleci\artifacts

workflows:
    run-all:
        jobs:
            - build
            - release:
                requires:
                    - build
